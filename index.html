<!--
[ログ・ホライズンＴＲＰＧ 特技一覧てすと]
Copyright (c) 2014 yamane
This software is released under the MIT License.
http://opensource.org/licenses/mit-license.php
※取得しているJSONデータの著作権はログ･ホライズンTRPG冒険窓口の記述に準じます。
-->
<!DOCTYPE HTML>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<title>LHTRPG 特技查詢</title>
	<style>
		html,
		body {
			font-family: 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans Regular', Tahoma, Verdana, sans-serif;
			font-size: 0.7em;
			line-height: 2.5em;
			color: #222;
		}

		.hidden {
			display: none;
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			justify-content: center;
			align-items: center;
		}

		.modal-window {
			background: #fff;
			padding: 20px;
			border-radius: 5px;
		}

		.modal-content {
			margin-top: 10px;
		}

		.modal.show {
			display: flex;
		}

		a:link,
		a:visited,
		a:link,
		a:visited {
			color: #333;
			text-decoration: underline;
		}

		a:hover,
		a:active,
		a:hover,
		a:active {
			color: #999;
			text-decoration: underline;
		}

		p {
			margin: 0;
			padding: 0;
		}

		input,
		select {
			vertical-align: middle;
		}

		.left {
			text-align: left;
		}

		.center {
			text-align: center;
		}

		.right {
			text-align: center;
		}

		table {
			width: 900px;
			border-collapse: collapse;
			margin-top: 10px;
		}

		table tr.odd {
			background-color: #eee;
		}

		table th {
			border: solid 1px #ccc;
			font-weight: normal;
			color: #fff;
			padding: 2px;
			background-color: #666;
		}

		table td {
			border: solid 1px #ccc;
			text-align: center;
		}

		table.nostyle {
			width: auto;
			#width: 1500px;
			border-spacing: 0;
			font-size: 13px;
		}

		table.nostyle th {
			color: #000;
			padding: 8px 15px;
			background: #eee;
			background: -moz-linear-gradient(#eee, #ddd 50%);
			background: -webkit-gradient(linear, 100% 0%, 100% 50%, from(#eee), to(#ddd));
			font-weight: bold;
			border-top: 1px solid #aaa;
			border-bottom: 1px solid #aaa;
			line-height: 120%;
			text-align: center;
			text-shadow: 0 -1px 0 rgba(255, 255, 255, 0.9);
			box-shadow: 0px 1px 1px rgba(255, 255, 255, 0.3) inset;
		}

		table.nostyle th:first-child {
			border-left: 1px solid #aaa;
			border-radius: 5px 0 0 0;
		}

		table.nostyle th:last-child {
			border-radius: 0 5px 0 0;
			border-right: 1px solid #aaa;
			#box-shadow: 2px 2px 1px rgba(0, 0, 0, 0.1);
		}

		table.nostyle tr td {
			padding: 8px 15px;
			text-align: center;
		}

		table.nostyle tr td:first-child {
			border-left: 1px solid #aaa;
		}

		table.nostyle tr td:last-child {
			border-right: 1px solid #aaa;
			#box-shadow: 2px 2px 1px rgba(0, 0, 0, 0.1);
		}

		table.nostyle tr {
			background: #fff;
		}

		table.nostyle tr:nth-child(2n+1) {
			background: #f5f5f5;
		}

		table.nostyle tr:last-child td {
			border-bottom: 1px solid #aaa;
			#box-shadow: 2px 2px 1px rgba(0, 0, 0, 0.1);
		}

		table.nostyle tr:last-child td:first-child {
			border-radius: 0 0 0 5px;
		}

		table.nostyle tr:last-child td:last-child {
			border-radius: 0 0 5px 0;
		}

		table.nostyle tr:hover {
			background: #eee;
			#cursor: pointer;
		}

		table.option {
			font-size: 1.2em;
		}

		.multiLine {
			white-space: pre-line;
		}

		.setting {
			font-size: 1.2em;
		}
	</style>
</head>

<body leftmargin="30" topmargin="10" rightmargin="30" bottommargin="10">
	<h3>LHTRPG 特技查詢</h3>
	<p>
		該工具為以<a href="https://unonek.sakura.ne.jp/lh/skl.html">[LHTRPG 特技検索]</a>為基礎，進行修改的中文版本。<br />
	</p>

	<input type="button" name="open_upload" value="匯入自訂特技" onMouseUp="open_upload_modal()">&nbsp;
	<input type="button" name="download" value="匯出自訂特技" onMouseUp="output_current_custom_skills()">&nbsp;
	<input type="button" name="clear_upload" value="清除匯入特技" onMouseUp="clear_uploaded_data()">&nbsp;<br />

	<div id="modal" class="modal">
		<div class="modal-window">
			<div class="setting">
				<label><input id="manual_mode_setting" type="checkbox" onchange="switchUploadMode()" style="
					width: 18px; height: 18px" />手動模式</label><br>
			</div>
			<label><input id="fileInput" type="file" accept=".json"></label>
			<table id="manual_mode" class="option hidden">
				<tr>
					<th colspan="2">手動設定</th>
				</tr>
				<tr>
					<td>特技名</td>
					<td class="left">
						<label><input id="custom_skill_name" type="text" size="25" value=""></label>
					</td>
				</tr>
				<tr>
					<td>標籤</td>
					<td class="left">
						<label><input id="custom_tags" type="text" size="60" value=""></label><br>
					</td>
				</tr>
				<tr>
					<td>類別</td>
					<td class="left" id="job_type_group">
						<label><input type="radio" name="job_type" value="共通特技" checked> 共通</label><br>
						<label><input type="radio" name="job_type" value="種族特技:人族"> 人族</label>
						<label><input type="radio" name="job_type" value="種族特技:精靈族"> 精靈族</label>
						<label><input type="radio" name="job_type" value="種族特技:矮人族"> 矮人族</label>
						<label><input type="radio" name="job_type" value="種族特技:半祖族"> 半祖族</label>
						<label><input type="radio" name="job_type" value="種族特技:貓人族"> 貓人族</label>
						<label><input type="radio" name="job_type" value="種族特技:狼牙族"> 狼牙族</label>
						<label><input type="radio" name="job_type" value="種族特技:狐尾族"> 狐尾族</label>
						<label><input type="radio" name="job_type" value="種族特技:法儀族"> 法儀族</label><br>

						<label><input type="radio" name="job_type" value="基礎職業特技:戰士職"> 戰士職</label>
						<label><input type="radio" name="job_type" value="基礎職業特技:回復職"> 回復職</label>
						<label><input type="radio" name="job_type" value="基礎職業特技:武器攻擊職"> 武器攻擊職</label>
						<label><input type="radio" name="job_type" value="基礎職業特技:魔法攻擊職"> 魔法攻擊職</label><br>

						<label><input type="radio" name="job_type" value="主職業特技:守護戰士"> 守護戰士</label>
						<label><input type="radio" name="job_type" value="主職業特技:武士"> 武士</label>
						<label><input type="radio" name="job_type" value="主職業特技:武鬥家"> 武鬥家</label>
						<label><input type="radio" name="job_type" value="主職業特技:牧師"> 牧師</label>
						<label><input type="radio" name="job_type" value="主職業特技:德魯伊"> 德魯伊</label>
						<label><input type="radio" name="job_type" value="主職業特技:神官"> 神官</label>
						<label><input type="radio" name="job_type" value="主職業特技:刺客"> 刺客</label>
						<label><input type="radio" name="job_type" value="主職業特技:盜劍士"> 盜劍士</label>
						<label><input type="radio" name="job_type" value="主職業特技:吟遊詩人"> 吟遊詩人</label>
						<label><input type="radio" name="job_type" value="主職業特技:妖術師"> 妖術師</label>
						<label><input type="radio" name="job_type" value="主職業特技:賦予術師"> 賦予術師</label><br>
					</td>
				</tr>
				<tr>
					<td>戰鬥/一般</td>
					<td class="left" id="type_group">
						<label><input type="radio" name="type" value="戰鬥" checked> 戰鬥</label>
						<label><input type="radio" name="type" value="一般"> 一般</label>
						<label><input type="radio" name="type" value="基本動作"> 基本</label>
						<label><input type="radio" name="type" value="ex power"> EX</label><br>
					</td>
				</tr>
				<tr>
					<td>最大SR</td>
					<td class="left">
						<label><input id="custom_max_sr" type="number" min="0" max="99" style="width: 60px;" value=""
								oninput="let num = parseInt(this.value, 10); this.value = !!this.value && !isNaN(num) && num >= 0 ? (num < 99 ? num : 99) : null"></label><br>
					</td>
				</tr>
				<tr>
					<td>時機</td>
					<td class="left" id="timing_group">
						<label><input type="radio" name="timing" value="常駐" checked> 常駐</label>
						<label><input type="radio" name="timing" value="設置階段"> 設置階段</label>
						<label><input type="radio" name="timing" value="先攻階段"> 先攻階段</label>
						<label><input type="radio" name="timing" value="移動動作"> 移動動作</label>
						<label><input type="radio" name="timing" value="次要動作"> 次要動作</label>
						<label><input type="radio" name="timing" value="主要動作"> 主要動作</label>
						<label><input type="radio" name="timing" value="行動"> 行動</label>
						<label><input type="radio" name="timing" value="即時動作"> 即時動作</label><br>
						<label><input type="radio" name="timing" value="傷害骰"> 傷害骰</label>
						<label><input type="radio" name="timing" value="承受傷害前"> 承受傷害前</label>
						<label><input type="radio" name="timing" value="承受傷害後"> 承受傷害後</label>
						<label><input type="radio" name="timing" value="判定前"> 判定前</label>
						<label><input type="radio" name="timing" value="判定後"> 判定後</label>
						<label><input type="radio" name="timing" value="清除階段"> 清除階段</label>
						<label><input type="radio" name="timing" value="跑團前"> 跑團前</label><br>
						<label><input type="radio" name="timing" value="簡令階段"> 簡令階段</label>
						<label><input type="radio" name="timing" value="見下文"> 見下文</label>
						<label><input type="radio" name="timing" value="休息階段"> 休息階段</label>
					</td>
				</tr>
				<tr>
					<td>判定</td>
					<td class="left">
						<label><input id="custom_roll" type="text" size="25" value=""></label><br>
					</td>
				</tr>
				<tr>
					<td>對象</td>
					<td class="left">
						<label><input id="custom_target" type="text" size="25" value=""></label><br>
					</td>
				</tr>
				<tr>
					<td>射程</td>
					<td class="left" id="range_group">
						<label><input type="radio" name="range" value="至近" checked> 至近</label>
						<label><input type="radio" name="range" value="1Sq"> 1Sq</label>
						<label><input type="radio" name="range" value="2Sq"> 2Sq</label>
						<label><input type="radio" name="range" value="4Sq"> 4Sq</label>
						<label><input type="radio" name="range" value="5Sq"> 5Sq</label>
						<label><input type="radio" name="range" value="6Sq"> 6Sq</label>
						<label><input type="radio" name="range" value="20Sq"> 20Sq</label>
						<label><input type="radio" name="range" value="武器"> 武器</label>
						<label><input type="radio" name="range" value="見下文"> 見下文</label>
						<label><input type="radio" id="custom_range_c" name="range" value="custom_value"> 自訂:</label>
						<label><input type="text" id="custom_range" size="10" value=""
								onfocus="document.getElementById('custom_range_c').checked = true;"></label><br>
					</td>
				</tr>
				<tr>
					<td>代價</td>
					<td class="left">
						<label><input id="custom_cost" type="text" size="25" value=""></label><br>
					</td>
				</tr>
				<tr>
					<td>限制</td>
					<td class="left">
						<label><input id="custom_limit" type="text" size="25" value=""></label><br>
					</td>
				</tr>
				<tr>
					<td>效果</td>
					<td class="left">
						<label><textarea id="custom_effect"
								style="width: 360px; height: 90px; resize:none;"></textarea></label><br>
					</td>
				</tr>
				<tr>
					<td>說明</td>
					<td class="left">
						<label><textarea id="custom_explain"
								style="width: 360px; height: 90px; resize:none;"></textarea></label><br>
					</td>
				</tr>
			</table>
			<div class="modal-content" style="visibility:hidden">
				選擇分類
			</div>
			<select id="typeSelect" style="display:none">
				<option value="skills">特技</option>
				<option value="basicActions">基本動作</option>
				<option value="ex_powers">ex power</option>
			</select>
			<button id="confirmBtn" disabled>確認</button>
			<button id="cancelBtn">取消</button>
		</div>
	</div>

	<form action="*" onsubmit="return false;">
		<table class="option">
			<tr>
				<th colspan="2">查詢條件</th>
			</tr>
			<tr>
				<td>特技名</td>
				<td class="left">
					<label><input id="sna" type="text" size="40" onfocus="tm_start();"
							onblur="tm_Off();" /></label>&nbsp;
				</td>
			</tr>
			<tr>
				<td>類別</td>
				<td class="left">
					<label><input id="com" type="checkbox" onchange="reloadData();" /> 共通</label>&nbsp;<br>
					<label><input id="hum" type="checkbox" onchange="reloadData();" /> 人族</label>&nbsp;
					<label><input id="elf" type="checkbox" onchange="reloadData();" /> 精靈族</label>&nbsp;
					<label><input id="dwf" type="checkbox" onchange="reloadData();" /> 矮人族</label>&nbsp;
					<label><input id="alv" type="checkbox" onchange="reloadData();" /> 半祖族</label>&nbsp;
					<label><input id="cat" type="checkbox" onchange="reloadData();" /> 貓人族</label>&nbsp;
					<label><input id="wlf" type="checkbox" onchange="reloadData();" /> 狼牙族</label>&nbsp;
					<label><input id="fox" type="checkbox" onchange="reloadData();" /> 狐尾族</label>&nbsp;
					<label><input id="ret" type="checkbox" onchange="reloadData();" /> 法儀族</label>&nbsp;<br>

					<label><input id="wor" type="checkbox" onchange="reloadData();" /> 戰士職</label>&nbsp;
					<label><input id="hel" type="checkbox" onchange="reloadData();" /> 回復職</label>&nbsp;
					<label><input id="wep" type="checkbox" onchange="reloadData();" /> 武器攻擊職</label>&nbsp;
					<label><input id="mag" type="checkbox" onchange="reloadData();" /> 魔法攻擊職</label>&nbsp;<br>

					<label><input id="gud" type="checkbox" onchange="reloadData();" /> 守護戰士</label>&nbsp;
					<label><input id="sam" type="checkbox" onchange="reloadData();" /> 武士</label>&nbsp;
					<label><input id="mnk" type="checkbox" onchange="reloadData();" /> 武鬥家</label>&nbsp;
					<label><input id="clr" type="checkbox" onchange="reloadData();" /> 牧師</label>&nbsp;
					<label><input id="drd" type="checkbox" onchange="reloadData();" /> 德魯伊</label>&nbsp;
					<label><input id="kng" type="checkbox" onchange="reloadData();" /> 神官</label>&nbsp;
					<label><input id="ass" type="checkbox" onchange="reloadData();" /> 刺客</label>&nbsp;
					<label><input id="swb" type="checkbox" onchange="reloadData();" /> 盜劍士</label>&nbsp;
					<label><input id="brd" type="checkbox" onchange="reloadData();" /> 吟遊詩人</label>&nbsp;
					<label><input id="scr" type="checkbox" onchange="reloadData();" /> 妖術師</label>&nbsp;
					<label><input id="smn" type="checkbox" onchange="reloadData();" /> 召喚術師</label>&nbsp;
					<label><input id="enc" type="checkbox" onchange="reloadData();" /> 賦予術師</label>&nbsp;<br>
				</td>
			</tr>
			<tr>
				<td>戰鬥/一般</td>
				<td class="left">
					<label><input id="bat" type="checkbox" onchange="reloadData();" checked="" /> 戰鬥</label>&nbsp;
					<label><input id="nor" type="checkbox" onchange="reloadData();" checked="" /> 一般</label>&nbsp;
					<label><input id="basic" type="checkbox" onchange="reloadData();" /> 基本</label>&nbsp;
					<label><input id="ex" type="checkbox" onchange="reloadData();" /> EX</label>&nbsp;<br />
				</td>
			</tr>
			<tr>
				<td>時機</td>
				<td class="left">
					<label><input id="psi" type="checkbox" onchange="reloadData();" /> 常駐</label>&nbsp;
					<label><input id="stu" type="checkbox" onchange="reloadData();" /> 設置階段</label>&nbsp;
					<label><input id="nti" type="checkbox" onchange="reloadData();" /> 先攻階段</label>&nbsp;
					<label><input id="mov" type="checkbox" onchange="reloadData();" /> 移動動作</label>&nbsp;
					<label><input id="min" type="checkbox" onchange="reloadData();" /> 次要動作</label>&nbsp;
					<label><input id="meg" type="checkbox" onchange="reloadData();" /> 主要動作</label>&nbsp;
					<label><input id="beh" type="checkbox" onchange="reloadData();" /> 行動</label>&nbsp;
					<label><input id="ins" type="checkbox" onchange="reloadData();" /> 即時動作</label>&nbsp;<br>
					<label><input id="dar" type="checkbox" onchange="reloadData();" /> 傷害骰</label>&nbsp;
					<label><input id="dab" type="checkbox" onchange="reloadData();" /> 承受傷害前</label>&nbsp;
					<label><input id="daa" type="checkbox" onchange="reloadData();" /> 承受傷害後</label>&nbsp;
					<label><input id="jub" type="checkbox" onchange="reloadData();" /> 判定前</label>&nbsp;
					<label><input id="jua" type="checkbox" onchange="reloadData();" /> 判定後</label>&nbsp;
					<label><input id="cle" type="checkbox" onchange="reloadData();" /> 清除階段</label>&nbsp;
					<label><input id="ppl" type="checkbox" onchange="reloadData();" /> 跑團前</label>&nbsp;<br>
					<label><input id="brf" type="checkbox" onchange="reloadData();" /> 簡令階段</label>&nbsp;
					<label><input id="tex" type="checkbox" onchange="reloadData();" /> 見下文</label>&nbsp;
					<label><input id="rst" type="checkbox" onchange="reloadData();" /> 休息階段</label>&nbsp;
				</td>
			</tr>
			<tr>
				<td>射程</td>
				<td class="left">
					<label><input id="cls" type="checkbox" onchange="reloadData();" /> 至近</label>&nbsp;
					<label><input id="one" type="checkbox" onchange="reloadData();" /> 1Sq</label>&nbsp;
					<label><input id="two" type="checkbox" onchange="reloadData();" /> 2Sq</label>&nbsp;
					<label><input id="fur" type="checkbox" onchange="reloadData();" /> 4Sq</label>&nbsp;
					<label><input id="fiv" type="checkbox" onchange="reloadData();" /> 5Sq</label>&nbsp;
					<label><input id="six" type="checkbox" onchange="reloadData();" /> 6Sq</label>&nbsp;
					<label><input id="twe" type="checkbox" onchange="reloadData();" /> 20Sq</label>&nbsp;
					<label><input id="wpn" type="checkbox" onchange="reloadData();" /> 武器</label>&nbsp;
					<label><input id="hon" type="checkbox" onchange="reloadData();" /> 見下文</label>&nbsp;
					<label><input id="srd" type="checkbox" onchange="reloadData();" /> 根據SR</label>&nbsp;
				</td>
			</tr>
			<tr>
				<td>效果</td>
				<td class="left">
					<label><input id="efe" type="text" size="40" onfocus="tm_start();"
							onblur="tm_Off();" /></label>&nbsp;(以空格切開後，可做or查詢)
				</td>
			</tr>
			<tr>
				<td>標籤</td>
				<td class="left">
					<label><span id='tag_list'>ヾ( ・ｗ・)ﾉ゛</span></label>
				</td>
			</tr>
			<tr>
				<td>選項</td>
				<td class="left">
					<label><input id="fct" type="checkbox" onchange="reloadData();" checked="" /> 顯示效果</label>&nbsp;
					<label><input id="exp" type="checkbox" onchange="reloadData();" /> 顯示說明</label>&nbsp;
					<label><input id="jp_fct" type="checkbox" onchange="reloadData();" />
						顯示原文效果</label>&nbsp;&nbsp;&nbsp;
					<input type="button" name="c_all" value="全選" onMouseUp="check_all()">&nbsp;
					<input type="button" name="r_all" value="清空" onMouseUp="reset_all()">&nbsp;<br />
					<label><input id="show_skill" type="checkbox" onchange="reloadData();" checked="" />
						顯示官方特技</label>&nbsp;
					<label><input id="show_custom_skill" type="checkbox" onchange="reloadData();" checked="" />
						顯示自訂特技</label>&nbsp;&nbsp;&nbsp;<br />
					查詢範圍：
					<label><input id="bk1" type="checkbox" onchange="reloadData();" checked="" />
						基本(book1)</label>&nbsp;
					<label><input id="bk2" type="checkbox" onchange="reloadData();" checked="" />
						拡張(book2)</label>&nbsp;
					<label><input id="etc" type="checkbox" onchange="reloadData();" checked="" />
						ウェンズディ・ガゼット(Gz)</label>&nbsp;
					<br />
				</td>
			</tr>
		</table>
	</form>
	<table class="nostyle">
		<thead>
			<tr>
				<th class="left" style="width:90px;">特技名</th>
				<th class="left">日文</th>
				<th class="left">標籤</th>
				<th style="width:70px;" nowrap>類別</th>
				<th nowrap>戰鬥/<br />一般</th>
				<th>MAX<br />SR</th>
				<th>時機</th>
				<th>判定</th>
				<th>對象</th>
				<th>射程</th>
				<th style="width:40px;">代價</th>
				<th>限制</th>
				<th>效果</th>
				<th id="jp_fct_th" class="hidden">原文效果</th>
			</tr>
		</thead>
		<tbody id="tablebody">
		</tbody>
	</table>


	<script type="text/javascript">

		//#region SkillType
		const enum_other = 0;
		const enum_skill = 1;
		const enum_basic = 2;
		const enum_ex = 3;
		//#endregion

		//#region expanded_skill
		var skill_dict = {};
		var index_dict;

		var custom_skill_dict = {};

		var all_skill_dicts = [skill_dict, custom_skill_dict]

		var jp_dict = {};
		//#endregion



		var skills = [];
		var tagl = [""];
		var timer1;
		var sna_value;
		var efe_value;


		function Sleep(T) {
			var d1 = new Date().getTime();
			var d2 = new Date().getTime();
			while (d2 < d1 + 1000 * T) {
				d2 = new Date().getTime();
			}
			return;
		}

		function tm_start() {
			timer1 = setInterval("check_input_changed()", 1000);
		}

		function tm_Off() {
			clearInterval(timer1);
			reloadData();
		}
		function check_input_changed() {
			var sna = document.getElementById('sna').value;
			var efe = document.getElementById('efe').value;
			let is_input_changed = sna !== sna_value || efe !== efe_value;
			if (is_input_changed) {
				reloadData();
				sna_value = sna;
				efe_value = efe;
			}
		}
		function reloadData() {
			var com = document.getElementById('com');

			var hum = document.getElementById('hum');
			var elf = document.getElementById('elf');
			var dwf = document.getElementById('dwf');
			var alv = document.getElementById('alv');
			var cat = document.getElementById('cat');
			var wlf = document.getElementById('wlf');
			var fox = document.getElementById('fox');
			var ret = document.getElementById('ret');

			var gud = document.getElementById('gud');
			var sam = document.getElementById('sam');
			var mnk = document.getElementById('mnk');
			var clr = document.getElementById('clr');
			var drd = document.getElementById('drd');
			var kng = document.getElementById('kng');
			var ass = document.getElementById('ass');
			var swb = document.getElementById('swb');
			var brd = document.getElementById('brd');
			var scr = document.getElementById('scr');
			var smn = document.getElementById('smn');
			var enc = document.getElementById('enc');

			var wor = document.getElementById('wor');
			var hel = document.getElementById('hel');
			var wep = document.getElementById('wep');
			var mag = document.getElementById('mag');

			var stu = document.getElementById('stu');
			var mov = document.getElementById('mov');
			var min = document.getElementById('min');
			var meg = document.getElementById('meg');
			var ins = document.getElementById('ins');
			var beh = document.getElementById('beh');
			var tex = document.getElementById('tex');
			var jub = document.getElementById('jub');
			var jua = document.getElementById('jua');
			var dar = document.getElementById('dar');
			var dab = document.getElementById('dab');
			var daa = document.getElementById('daa');
			var nti = document.getElementById('nti');
			var cle = document.getElementById('cle');
			var brf = document.getElementById('brf');
			var rst = document.getElementById('rst');
			var ppl = document.getElementById('ppl');
			var psi = document.getElementById('psi');

			var cls = document.getElementById('cls');
			var one = document.getElementById('one');
			var two = document.getElementById('two');
			var fur = document.getElementById('fur');
			var fiv = document.getElementById('fiv');
			var six = document.getElementById('six');
			var twe = document.getElementById('twe');
			var wpn = document.getElementById('wpn');
			var hon = document.getElementById('hon');
			var srd = document.getElementById('srd');

			var bat = document.getElementById('bat');
			var nor = document.getElementById('nor');
			var basic = document.getElementById('basic');
			var ex = document.getElementById('ex');

			var efe = document.getElementById('efe').value;
			var sna = document.getElementById('sna').value;

			var tna = document.getElementById('tna').selectedIndex;
			tna = tagl[tna];

			var fct = document.getElementById('fct');
			var exp = document.getElementById('exp');
			var jp_fct = document.getElementById('jp_fct');
			var bk1 = document.getElementById('bk1');
			var bk2 = document.getElementById('bk2');
			var etc = document.getElementById('etc');

			var jp_fct_th = document.getElementById('jp_fct_th');

			var show_skill = document.getElementById('show_skill');
			var show_custom_skill = document.getElementById('show_custom_skill');

			var f1 = 0;//特技種別のチェックあるなし
			var f2 = 0;//タイミングのチェックあるなし
			var f3 = 0;//効果の書き込みあるなし
			//f4 効果の判定
			//f5 タグの判定
			var f6 = 0;//特技名の書き込みあるなし
			var f7 = 0;//タイミングのチェックあるなし
			var f8 = 0;//是否只選非特技資料
			var col_count = 13;

			for (var i = 1; i < 26; i++) {
				if (document.forms[0].elements[i].checked == true) {
					f1 = 1;
					break;
				}
			}
			for (var i = 30; i < 49; i++) {
				if (document.forms[0].elements[i].checked == true) {
					f2 = 1;
					break;
				}
			}
			if (efe != "") {
				f3 = 1;
				var efect = [];
				var efect_set = new Set();
				var raw_efect = efe.split(/\s/);
				for (var i = 0; i < raw_efect.length; i++) {
					if (!efect_set.has(raw_efect[i])) {
						efect_set.add(raw_efect[i]);
						efect.push(raw_efect[i]);
					}
					var escape_efect = escape(raw_efect[i]);
					if (!efect_set.has(escape_efect)) {
						efect_set.add(escape_efect);
						efect.push(escape_efect);
					}
				}
			}
			if (sna != "") {
				f6 = 1;
				var s_name = escape(sna);
			}
			for (var i = 49; i < 59; i++) {
				if (document.forms[0].elements[i].checked == true) {
					f7 = 1;
					break;
				}
			}
			if (jp_fct.checked) {
				jp_fct_th.classList.remove('hidden');
				col_count++;
			}
			else {
				jp_fct_th.classList.add('hidden');
			}
			var tbody = document.getElementById("tablebody");
			tbody.innerHTML = "";
			var dispCount = 0;

			for (let dict_index = 0; dict_index < all_skill_dicts.length; dict_index++) {
				let dict = all_skill_dicts[dict_index];
				let isCustomData = dict == custom_skill_dict;
				if (!show_skill.checked && dict == skill_dict) {
					continue;
				}
				if (!show_custom_skill.checked && isCustomData) {
					continue;
				}

				for (let dict_key in dict) {
					let skills = dict[dict_key];
					for (var i = 0; i < skills.length; i++) {
						if (!bk1.checked && !bk2.checked && !etc.checked) {
							break;
						} else {
							if (!bk1.checked && skills[i].post == "Book1") {
								continue;
							}
							if (!bk2.checked && skills[i].post == "Book2") {
								continue;
							}
							if (!etc.checked && skills[i].post == "その他") {
								continue;
							}
							if ((!bk1.checked || !bk2.checked || !etc.checked) && skills[i].post === null) {
								continue;
							}
						}
						var post1 = skills[i].post;
						post1 = post1 === null ? null : post1.replace("その他", "Gz");
						var type2 = skills[i].type;
						var f4 = 0;//効果ノチェック
						if (document.forms[0].elements[26].checked == false &&
							document.forms[0].elements[27].checked == false &&
							(document.forms[0].elements[28].checked ||
								document.forms[0].elements[29].checked)
						) {
							f8 = 1;
						}
						//if(!ads.checked && skills[i].function.match(/Ｂ２/)) {
						//continue;
						//}
						if (!bat.checked && type2 == "戰鬥") {
							continue;
						}
						if (!nor.checked && type2 == "一般") {
							continue;
						}
						if (!basic.checked && type2 == "基本動作") {
							continue;
						}
						if (!ex.checked && type2 == "ex power") {
							continue;
						}
						if (f1 == 0 && f2 == 0 && f3 == 0 && f4 == 0 && tna == "" && f6 == 0 && f7 == 0 && f8 == 0) {
							continue;
						}

						var type1 = skills[i].job_type;
						type1 = type1.replace("共通特技", "共通");
						type1 = type1.replace("種族特技:", "");
						type1 = type1.replace("基礎職業特技:", "");
						type1 = type1.replace("主職業特技:", "");

						if (f1 == 1) {
							if (!com.checked && type1 == "共通") {
								continue;
							}

							if (!hum.checked && type1 == "人族") {
								continue;
							}
							if (!elf.checked && type1 == "精靈族") {
								continue;
							}
							if (!dwf.checked && type1 == "矮人族") {
								continue;
							}
							if (!alv.checked && type1 == "半祖族") {
								continue;
							}
							if (!cat.checked && type1 == "貓人族") {
								continue;
							}
							if (!wlf.checked && type1 == "狼牙族") {
								continue;
							}
							if (!fox.checked && type1 == "狐尾族") {
								continue;
							}
							if (!ret.checked && type1 == "法儀族") {
								continue;
							}

							if (!wor.checked && type1 == "戰士職") {
								continue;
							}
							if (!hel.checked && type1 == "回復職") {
								continue;
							}
							if (!wep.checked && type1 == "武器攻擊職") {
								continue;
							}
							if (!mag.checked && type1 == "魔法攻擊職") {
								continue;
							}

							if (!gud.checked && type1 == "守護戰士") {
								continue;
							}
							if (!sam.checked && type1 == "武士") {
								continue;
							}
							if (!mnk.checked && type1 == "武鬥家") {
								continue;
							}
							if (!clr.checked && type1 == "牧師") {
								continue;
							}
							if (!drd.checked && type1 == "德魯伊") {
								continue;
							}
							if (!kng.checked && type1 == "神官") {
								continue;
							}
							if (!ass.checked && type1 == "刺客") {
								continue;
							}
							if (!swb.checked && type1 == "盜劍士") {
								continue;
							}
							if (!brd.checked && type1 == "吟遊詩人") {
								continue;
							}
							if (!scr.checked && type1 == "妖術師") {
								continue;
							}
							if (!smn.checked && type1 == "召喚術師") {
								continue;
							}
							if (!enc.checked && type1 == "賦予術師") {
								continue;
							}
						}

						if (f2 == 1) {
							if (!stu.checked && skills[i].timing == "設置階段") {
								continue;
							}
							if (!mov.checked && skills[i].timing == "移動動作") {
								continue;
							}
							if (!min.checked && skills[i].timing == "次要動作") {
								continue;
							}
							if (!meg.checked && skills[i].timing == "主要動作") {
								continue;
							}
							if (!ins.checked && skills[i].timing == "即時動作") {
								continue;
							}
							if (!beh.checked && skills[i].timing == "行動") {
								continue;
							}
							if (!tex.checked && skills[i].timing == "見下文") {
								continue;
							}
							if (!jub.checked && skills[i].timing == "判定前") {
								continue;
							}
							if (!jua.checked && skills[i].timing == "判定後") {
								continue;
							}
							if (!dar.checked && skills[i].timing == "傷害骰") {
								continue;
							}
							if (!dab.checked && skills[i].timing == "承受傷害前") {
								continue;
							}
							if (!daa.checked && skills[i].timing == "承受傷害後") {
								continue;
							}
							if (!nti.checked && skills[i].timing == "先攻階段") {
								continue;
							}
							if (!cle.checked && skills[i].timing == "清除階段") {
								continue;
							}
							if (!brf.checked && skills[i].timing == "簡令階段") {
								continue;
							}
							if (!rst.checked && skills[i].timing == "休息階段") {
								continue;
							}
							if (!ppl.checked && skills[i].timing == "跑團前") {
								continue;
							}
							if (!psi.checked && skills[i].timing == "常駐") {
								continue;
							}
						}
						if (f3 == 1) {
							for (var j = 0; j < efect.length; j++) {
								var re = new RegExp(efect[j], "i");
								if (!efect[j] == "" && skills[i].function.match(re)) {
									f4 = 1;
									break;
								}
							}
							if (f4 == 0) {
								continue;
							}
						}
						if (!tna == "") {
							var f5 = 0;//タグの有無
							var re = new RegExp(tna, "i");
							for (var j = 0; j < skills[i].tags.length; j++) {
								if (skills[i].tags[j] == tna) {
									f5 = 1;
									break;
								}
							}
							if (f5 == 0) {
								continue;
							}
						}

						if (f6 == 1) {
							var re = new RegExp(s_name, "i");
							if (!skills[i].name.match(re) && !skills[i].name.match(new RegExp(sna, "i"))) {
								continue;
							}
						}
						if (f7 == 1) {
							if (!cls.checked && skills[i].range == "至近") {
								continue;
							}
							if (!one.checked && skills[i].range == "1Sq") {
								continue;
							}
							if (!two.checked && skills[i].range == "2Sq") {
								continue;
							}
							if (!fur.checked && skills[i].range == "4Sq") {
								continue;
							}
							if (!fiv.checked && skills[i].range == "5Sq") {
								continue;
							}
							if (!six.checked && skills[i].range == "6Sq") {
								continue;
							}
							if (!twe.checked && skills[i].range == "20Sq") {
								continue;
							}
							if (!wpn.checked && skills[i].range == "武器") {
								continue;
							}
							if (!hon.checked && skills[i].range == "見下文") {
								continue;
							}
							if (!srd.checked && skills[i].range.match(/SR/)) {
								continue;
							}
						}

						var row = document.createElement('tr');
						if (dispCount % 2 == 0) {
							row.setAttribute("class", "odd");
						}

						var name = skills[i].name;
						var regex = /(.*)\((.*)\)/;
						var matches = name.match(regex);
						var zhName = matches ? matches[1] : name;
						var jpName = matches ? matches[2] : name;

						var nameCol = document.createElement('td');
						nameCol.innerHTML = zhName;
						nameCol.setAttribute("class", "left");
						row.appendChild(nameCol);

						var name2Col = document.createElement('td');
						name2Col.innerHTML = jpName;
						name2Col.setAttribute("class", "left");
						row.appendChild(name2Col);

						var tagCol = document.createElement('td');
						tagCol.innerHTML = skills[i].tags;
						tagCol.setAttribute("class", "left");
						row.appendChild(tagCol);

						var type1Col = document.createElement('td');
						type1Col.innerHTML = type1;
						row.appendChild(type1Col);

						var type2Col = document.createElement('td');
						type2Col.innerHTML = skills[i].type;
						row.appendChild(type2Col);

						var srCol = document.createElement('td');
						srCol.innerHTML = skills[i].skill_max_rank;
						row.appendChild(srCol);

						var timingCol = document.createElement('td');
						timingCol.innerHTML = skills[i].timing;
						row.appendChild(timingCol);

						var judgeCol = document.createElement('td');
						judgeCol.innerHTML = skills[i].roll;
						row.appendChild(judgeCol);

						var targetCol = document.createElement('td');
						targetCol.innerHTML = skills[i].target;
						row.appendChild(targetCol);

						var rangeCol = document.createElement('td');
						rangeCol.innerHTML = skills[i].range;
						row.appendChild(rangeCol);

						var costCol = document.createElement('td');
						costCol.innerHTML = skills[i].cost;
						row.appendChild(costCol);

						var limitCol = document.createElement('td');
						limitCol.innerHTML = skills[i].limit;
						row.appendChild(limitCol);

						var efectCol = document.createElement('td');
						efectCol.setAttribute("class", "multiLine");
						if (fct.checked) {
							efectCol.innerHTML = skills[i].function + (post1 === null ? "" : "(" + post1 + ")");
						} else {
							efectCol.innerHTML = "";
						}
						row.appendChild(efectCol);

						if (jp_fct.checked) {
							var jp_efectCol = document.createElement('td');
							jp_efectCol.innerHTML = !isCustomData ? get_jp_effect(skills[i]["id"], dict_key) : '－';
							row.appendChild(jp_efectCol);
						}

						tbody.appendChild(row);

						if (exp.checked) {
							var row2 = document.createElement('tr');
							if (dispCount % 2 == 0) {
								row2.setAttribute("class", "odd");
							}
							var functionCol = document.createElement('td');
							functionCol.setAttribute("colspan", col_count);
							functionCol.setAttribute("class", "left multiLine");
							var funtionText = "";
							var explainText = "";
							//if(fct.checked) {
							//funtionText = "<p>効果：" + skills[i].function + "</p>";
							//}
							if (exp.checked) {
								explainText = "<p>說明：" + skills[i].explain + "</p>";
							}
							functionCol.innerHTML = funtionText + explainText;
							row2.appendChild(functionCol);
							tbody.appendChild(row2);
						}

						dispCount++;
					}
				}
			}
		}
		//重複チェック
		var checkDuplicate = function (array, str) {
			var array = array;
			var str = str;
			for (var i = 0; i < array.length; i++) {
				if (str == array[i]) {
					return true;
				}
			}
			return false;
		};
		// 初期化1
		window.onload = function () {
			//var script = document.createElement('script');
			//script.src = "https://lhrpg.com/lhz/api/skills.json?callback=jsonp";
			//document.body.appendChild(script);

			load_skill("https://banana0229.github.io/LHZSheetViewer/data/zh/skills.json", enum_skill);
			load_skill("https://banana0229.github.io/LHZSheetViewer/data/zh/basicActions.json", enum_basic);
			load_skill("https://banana0229.github.io/LHZSheetViewer/data/zh/ex_powers.json", enum_ex);

			//merge_skill_dict();
			//remove_duplicate_id();

			var jp_skill_request = new XMLHttpRequest();
			jp_skill_request.onreadystatechange = function () {
				if (jp_skill_request.readyState == 4 && jp_skill_request.status == 200) {
					let jp_data = JSON.parse(jp_skill_request.responseText);

					jp_dict[enum_skill] = {}
					for (let i = 0; i < jp_data.skills.length; i++) {
						let data = jp_data.skills[i];
						if (data) {
							jp_dict[enum_skill][data["id"]] = data;
						}
					}
				}
			};
			jp_skill_request.open("GET", "https://lhrpg.com/lhz/api/skills.json");
			jp_skill_request.send();

			var jp_basic_request = new XMLHttpRequest();
			jp_basic_request.onreadystatechange = function () {
				if (jp_basic_request.readyState == 4 && jp_basic_request.status == 200) {
					let jp_data = JSON.parse(jp_basic_request.responseText);

					jp_dict[enum_basic] = {}
					for (let i = 0; i < jp_data.basicActions.length; i++) {
						let data = jp_data.basicActions[i];
						if (data) {
							jp_dict[enum_basic][data["id"]] = data;
						}
					}
				}
			};
			jp_basic_request.open("GET", "https://banana0229.github.io/LHZSheetViewer/data/jp/basicActions.json");
			jp_basic_request.send();

			var jp_ex_request = new XMLHttpRequest();
			jp_ex_request.onreadystatechange = function () {
				if (jp_ex_request.readyState == 4 && jp_ex_request.status == 200) {
					let jp_data = JSON.parse(jp_ex_request.responseText);

					jp_dict[enum_ex] = {}
					for (let i = 0; i < jp_data.ex_powers.length; i++) {
						let data = jp_data.ex_powers[i];
						if (data) {
							jp_dict[enum_ex][data["id"]] = data;
						}
					}
				}
			};
			jp_ex_request.open("GET", "https://banana0229.github.io/LHZSheetViewer/data/jp/ex_powers.json");
			jp_ex_request.send();

			let savedData = loadFromLocalStorage("custom_skill_dict");

			for (var prop in savedData) {
				custom_skill_dict[prop] = savedData[prop];
			}
			//console.log(savedData);
		};

		function load_skill(url, enum_type = enum_other) {
			var request = new XMLHttpRequest();
			request.onreadystatechange = function () {
				if (request.readyState == 4 && request.status == 200) {
					let json_data = JSON.parse(request.responseText);
					for (let key in json_data) {
						let data = json_data[key];
						push_skill_dict(data, { "type": enum_type });
					}
				}
				reload_tags();
			};
			request.open("GET", url);
			request.send();
		}

		function push_custom_skill(ad_skill, options = {}) {
			options["container"] = custom_skill_dict;
			push_skill_dict(ad_skill, options)
			saveToLocalStorage("custom_skill_dict", custom_skill_dict);
		}

		function push_skill_dict(ad_skill, options = {}) {
			let container = skill_dict;
			let type = enum_other;

			if (options["container"]) {
				container = options["container"];
			}
			if (options["type"]) {
				type = options["type"];
			}

			container[type] = push_skill(container[type], ad_skill);
		}

		function merge_skill_dict() {
			skills = [];
			//重複檢查改到這裡，這裡會做兩個dict的完全merge
			for (let dict_key in skill_dict) {
				let skill_list = skill_dict[dict_key];

				if (skill_list != undefined && skill_list != null) {
					skills = push_skill(skills, skill_list)
				}
			}

			for (let dict_key in custom_skill_dict) {
				let skill_list = custom_skill_dict[dict_key];

				if (skill_list != undefined && skill_list != null) {
					skills = push_skill(skills, skill_list)
				}
			}
		}

		//スキル追加
		function push_skill(container, ad_skill) {
			if (!container) {
				container = ad_skill;
				return container;
			}
			var j = 0;
			var end = container.length + ad_skill.length;
			for (var i = container.length; i < end; i++) {
				container[i] = ad_skill[j];
				j++;
			}
			return container;
		}

		function reload_tags() {
			tag_list();
			var tag_box = "";
			for (var i = 0; i < tagl.length; i++) {
				tag_box += "<option value='" + i + "'>" + tagl[i] + "</option>";
			}
			tag_box = "<select id='tna' name='tna' size='1' tabindex='0' onchange='reloadData();'/>" + tag_box + "</select>";
			document.getElementById('tag_list').innerHTML = tag_box;
		}

		function remove_duplicate_id() {
			//TODO: remove_duplicate
			index_dict = {}
			for (let dict_key in skill_dict) {
				let skill_list = skill_dict[dict_key];

				index_dict[dict_key] = {};
				for (var i = 0; i < skill_list.length; i++) {
					let skill = skill_list[i]
					if (index_dict[dict_key][skill["id"]] == undefined) {
						index_dict[dict_key][skill["id"]] = i;
					}
					else {
						//有重複資料，需要後蓋前，注意後續index
						//什麼都不做的話會保留原始的index，但不會移除資料
					}

				}
			}
		}

		function escape(str) {
			str = str.replace(/&/g, '&amp;');
			str = str.replace(/</g, '&lt;');
			str = str.replace(/>/g, '&gt;');
			str = str.replace(/"/g, '&quot;');
			str = str.replace(/'/g, '&#39;');
			str = str.replace(/[A-Za-z0-9]/g, function (s) {
				return String.fromCharCode(s.charCodeAt(0) + 65248);
			});
			return str;
		}

		function tag_list() {
			for (let i = 0; i < all_skill_dicts.length; i++) {
				let dict = all_skill_dicts[i];
				for (let dict_key in dict) {
					let skills = dict[dict_key];
					for (var j = 0; j < skills.length; j++) {
						for (var k = 0; k < skills[j].tags.length; k++) {
							var tag = skills[j].tags[k]
							if (!checkDuplicate(tagl, tag)) {
								tagl.push(tag);
							}
						}
					}
				}
			}
		}

		function check_all() {
			for (var i = 1; i < 59; i++) {
				document.forms[0].elements[i].checked = true;
			}
			reloadData();
		}

		function reset_all() {
			for (var i = 1; i < 59; i++) {
				document.forms[0].elements[i].checked = false;
			}
			document.forms[0].elements[26].checked = true;
			document.forms[0].elements[27].checked = true;
			document.getElementById('efe').value = "";
			document.getElementById('sna').value = "";
			document.getElementById('tna').selectedIndex = 0;
			document.forms[0].elements[60].checked = true;
			document.forms[0].elements[61].checked = false;
			document.forms[0].elements[62].checked = false;

			document.forms[0].elements[65].checked = true;
			document.forms[0].elements[66].checked = true;

			document.forms[0].elements[67].checked = true;
			document.forms[0].elements[68].checked = true;
			document.forms[0].elements[69].checked = true;
			reloadData();
		}

		function get_jp_effect(id, type_enum) {
			//return id;
			if (jp_dict[type_enum] && jp_dict[type_enum][id]) {
				return jp_dict[type_enum][id].function;
			}
			return "－";
		}

		function open_upload_modal() {
			document.getElementById('modal').classList.add('show');
		}
		function close_upload_modal() {
			//隱藏彈窗
			document.getElementById('modal').classList.remove('show');
			//關閉確認
			document.getElementById('confirmBtn').disabled = true;
			//清除設定
			document.getElementById('fileInput').value = '';
			document.getElementById('typeSelect').value = "skills";
			clearManualInputValue();
		}
		function clear_uploaded_data() {
			for (var prop in custom_skill_dict) {
				if (custom_skill_dict.hasOwnProperty(prop)) {
					delete custom_skill_dict[prop];
				}
			}
			//custom_skill_dict = {};
			tagl = [""];
			//merge_skill_dict();
			reload_tags();
			clearLocalStorage();
			reloadData();
		}

		function openjson_local(file, option = {}) {
			let type = "skills";
			if (option["type"]) {
				type = option["type"];
			}

			let reader = new FileReader();
			reader.readAsText(file, "UTF-8");
			reader.onload = function () {
				let uploaded_data = JSON.parse(reader.result);
				let type_enum = enum_other;
				if (type === "skills") {
					type_enum = enum_skill;
				}
				else if (type === "basicActions") {
					type_enum = enum_basic;
				}
				else if (type === "ex_powers") {
					type_enum = enum_ex;
				}

				for (let key in uploaded_data) {
					let data = uploaded_data[key];
					let isLegal = check_skill_data(data);
					if (isLegal) {
						push_custom_skill(data/*, { "type": type_enum }*/);
					}
					else {
						alert("資料格式錯誤！");
						break;
					}
				}

				close_upload_modal();
				//merge_skill_dict();
				reload_tags();
				reloadData();
			}
		}

		function check_skill_data(skill_list = []) {
			let necessary_pro_list = ["job_type", "type", "name", "skill_max_rank", "timing", "roll", "target", "range", "cost", "post", "limit",
				"tags",
				"function", "explain", "id"];

			for (var i = 0; i < skill_list.length; i++) {
				for (var j = 0; j < necessary_pro_list.length; j++) {
					if (!skill_list[i].hasOwnProperty(necessary_pro_list[j])) {
						return false;
					}
					if (!Array.isArray(skill_list[i].tags)) {
						return false;
					}
				}
			}
			return true;
		}

		function output_current_custom_skills() {
			let output_data = {};
			output_data["skills"] = [];
			for (key in custom_skill_dict) {
				let skills = custom_skill_dict[key];
				skills = push_skill(output_data["skills"], skills);
			}
			if (output_data["skills"].length > 0) {
				write_json(output_data, "custom_skills.json")
			}
			else {
				alert("錯誤！找不到已上傳的特技資料。");
				return;
			}
		}

		function write_json(data = {}, file_name = "output.json") {
			let str = JSON.stringify(data);
			if (str.localeCompare("{}") == 0) {
				alert("錯誤！\n無法取得資料。");
				return;
			}
			let ary = str.split(''); // 配列形式に変換（後述のBlobで全要素出力）
			let blob = new Blob(ary, { type: "text/json" }); // テキスト形式でBlob定義
			let link = document.createElement('a'); // HTMLのaタグを作成
			link.href = URL.createObjectURL(blob); // aタグのhref属性を作成
			link.download = file_name; // aタグのdownload属性を作成
			link.click(); // 定義したaタグをクリック（実行）
		}

		function saveToLocalStorage(key, value) {
			localStorage.setItem(key, JSON.stringify(value));
			console.log(`Saved ${key}:`, value);
		}

		// 從 localStorage 載入數據
		function loadFromLocalStorage(key) {
			const value = localStorage.getItem(key);
			if (value) {
				console.log(`Loaded ${key}:`, JSON.parse(value));
				return JSON.parse(value);
			} else {
				console.log(`${key} does not exist.`);
				return null;
			}
		}

		// 清除所有 localStorage 的數據
		function clearLocalStorage() {
			localStorage.clear();
			console.log(`All localStorage data removed`);
		}

		function getRadioValue(name) {
			var ele = document.getElementsByName(name);

			for (i = 0; i < ele.length; i++) {
				if (ele[i].checked) {
					if (ele[i].value === "custom_value") {
						return getCustomValue(name);
					}
					else {
						return ele[i].value;
					}
				}
			}
			return null;
		}

		function clearRadioValue(name) {
			var ele = document.getElementsByName(name);

			for (i = 0; i < ele.length; i++) {
				ele[i].checked = true;
				return;
			}
		}

		function getCustomValue(type) {
			var ele = document.getElementById(`custom_${type}`);

			if (ele) {
				return ele.value;
			}
			return null;
		}

		function setCustomValue(type, value) {
			var ele = document.getElementById(`custom_${type}`);

			if (ele) {
				ele.value = value;
			}
		}

		function getManualCustomData() {
			let manualData = {};
			manualData["job_type"] = getRadioValue("job_type");
			manualData["type"] = getRadioValue("type");
			manualData["name"] = getCustomValue("skill_name");
			manualData["skill_rank"] = null;
			let raw_max_sr = getCustomValue("max_sr");
			let max_sr = parseInt(raw_max_sr, 10);
			manualData["skill_max_rank"] = !isNaN(max_sr) ? max_sr : 0;
			manualData["timing"] = getRadioValue("timing");
			let rawRoll = getCustomValue("roll");
			manualData["roll"] = rawRoll != "" ? rawRoll : "無判定";
			manualData["target"] = getCustomValue("target");
			manualData["range"] = getRadioValue("range");
			let rawCost = getCustomValue("cost");
			manualData["cost"] = rawCost != "" ? rawCost : "-";
			manualData["post"] = null;//temp
			let rawLimit = getCustomValue("limit");
			manualData["limit"] = rawLimit != "" ? rawLimit : "-";
			let rawTags = getCustomValue("tags");
			let tags = rawTags.split(/,/).map(tag => tag.trim());
			manualData["tags"] = tags;
			manualData["function"] = getCustomValue("effect");
			manualData["explain"] = getCustomValue("explain");
			manualData["id"] = 0;//temp

			return manualData;
		}
		function uploadManualCustomData() {
			let skill_data = getManualCustomData();
			let skill_data_list = [skill_data];
			let isLegal = check_skill_data(skill_data_list);
			if (isLegal) {
				push_custom_skill(skill_data_list/*, { "type": type_enum }*/);
			}
			return isLegal;
		}
		function clearManualInputValue() {
			clearRadioValue("job_type");
			clearRadioValue("type");
			setCustomValue("skill_name", "");
			setCustomValue("max_sr", "");
			clearRadioValue("timing");
			setCustomValue("roll", "");
			setCustomValue("target", "");
			clearRadioValue("range");
			setCustomValue("range", "");
			setCustomValue("cost", "");
			setCustomValue("limit", "");
			setCustomValue("tags", "");
			setCustomValue("effect", "");
			setCustomValue("explain", "");
		}
		function switchUploadMode() {
			let manual_mode_setting = document.getElementById('manual_mode_setting');
			let is_manual = manual_mode_setting.checked;

			let manual_mode = document.getElementById('manual_mode');
			let file_mode = document.getElementById('fileInput');

			if (is_manual) {
				manual_mode.classList.remove('hidden');
				file_mode.classList.add('hidden');

				//clear file
				file_mode.value = '';
				document.getElementById('typeSelect').value = "skills";

				//refresh confirm button
				document.getElementById('confirmBtn').disabled = true;
			}
			else {
				manual_mode.classList.add('hidden');
				file_mode.classList.remove('hidden');

				//clear manual input
				clearManualInputValue();

				//refresh confirm button
				document.getElementById('confirmBtn').disabled = true;
			}
		}
		document.getElementById('custom_skill_name').addEventListener('input', function () {
			//有特技名稱才能確認
			let confirmBtn = document.getElementById('confirmBtn');
			confirmBtn.disabled = !(this.value !== "");
		});

		//選擇檔案
		document.getElementById('fileInput').addEventListener('change', function () {
			//有上傳檔案才能確認
			let confirmBtn = document.getElementById('confirmBtn');
			confirmBtn.disabled = !this.files.length;
		});
		//取消
		document.getElementById('cancelBtn').addEventListener('click', function () {
			close_upload_modal();
		});
		//確認
		document.getElementById('confirmBtn').addEventListener('click', function () {
			let manual_mode_setting = document.getElementById('manual_mode_setting');
			let is_manual = manual_mode_setting.checked;

			if (is_manual) {
				if (uploadManualCustomData()) {
					clearManualInputValue();
					this.disabled = true;
				}
				else {
					alert('上傳失敗\n請重新檢查格式');
				}
			}
			else {
				let fileInput = document.getElementById('fileInput');
				let typeSelect = document.getElementById('typeSelect');
				let file = fileInput.files[0];
				let type = typeSelect.value;

				if (!file) {
					alert('找不到指定檔案\n請重新上傳');
					return;
				}
				openjson_local(file, { "type": type })
			}
		});
	</script>
</body>

</html>